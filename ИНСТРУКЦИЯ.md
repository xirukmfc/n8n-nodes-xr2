# Инструкция по работе с xR2 n8n SDK

Полное руководство на русском языке по тестированию, использованию и публикации вашего n8n SDK для xR2 API.

---

## 1. Как тестировать SDK локально

### Вариант A: Локальное тестирование с npm link (Рекомендуется для разработки)

#### Шаг 1: Подготовка SDK

```bash
cd /Users/pavelkuzko/Documents/channeler/xR2/sdk/n8n

# Установить зависимости
npm install

# Собрать проект
npm run build

# Создать глобальную ссылку
npm link
```

#### Шаг 2: Установка n8n (если еще не установлен)

```bash
# Установить n8n глобально
npm install n8n -g
```

#### Шаг 3: Подключение SDK к n8n

```bash
# Создать директорию для кастомных нод
mkdir -p ~/.n8n/custom

# Перейти в эту директорию
cd ~/.n8n/custom

# Создать ссылку на ваш SDK
npm link n8n-nodes-xr2
```

#### Шаг 4: Запуск n8n

```bash
# Запустить n8n (откроется на http://localhost:5678)
n8n start

# Для отладки с подробными логами:
n8n start --verbose
```

#### Шаг 5: Настройка учетных данных в n8n

1. Откройте n8n в браузере: http://localhost:5678
2. Перейдите в **Settings** → **Credentials** → **New**
3. Найдите "xR2 API"
4. Вставьте ваш Product API ключ (формат: `xr2_prod_...`)
5. Нажмите **Save**

### Вариант B: Тестирование упакованной версии

```bash
cd /Users/pavelkuzko/Documents/channeler/xR2/sdk/n8n

# Собрать проект
npm run build

# Создать .tgz файл
npm pack

# Установить в n8n
cd ~/.n8n/custom
npm install /Users/pavelkuzko/Documents/channeler/xR2/sdk/n8n/n8n-nodes-xr2-0.1.0.tgz

# Перезапустить n8n
```

### Тестовые сценарии

#### Тест 1: Получение промпта

1. Создайте новый workflow
2. Добавьте **Manual Trigger**
3. Добавьте **xR2** ноду:
   - Resource: `Prompt`
   - Operation: `Get`
   - Slug: укажите slug вашего промпта (например, `welcome`)
   - Version Number: `0` (последняя версия)
4. Нажмите **Test workflow**

**Ожидаемый результат:**
```json
{
  "content": "Содержимое вашего промпта",
  "variables": {...},
  "model_config": {...},
  "trace_id": "uuid-здесь",
  "version_number": 1,
  "status": "production"
}
```

#### Тест 2: Получение промпта + Отслеживание события

1. **xR2 Node** (Get Prompt) → получить промпт
2. **xR2 Node** (Track Event):
   - Trace ID: `{{ $json.trace_id }}`
   - Event Name: `sign_up`
   - User ID: `user_123`
   - Metadata: `{}`

#### Тест 3: Интеграция с OpenAI

1. **xR2 Node** (Get Prompt) → получить промпт и конфигурацию модели
2. **HTTP Request Node**:
   - Method: POST
   - URL: `https://api.openai.com/v1/chat/completions`
   - Headers: `Authorization: Bearer YOUR_OPENAI_KEY`
   - Body:
   ```json
   {
     "model": "{{ $('xR2').item.json.model_config.model_name }}",
     "messages": [
       {
         "role": "system",
         "content": "{{ $('xR2').item.json.content }}"
       }
     ]
   }
   ```
3. **xR2 Node** (Track Event) → записать событие об использовании LLM

### Проверочный чеклист

- [ ] SDK собирается без ошибок (`npm run build`)
- [ ] Нода появляется в палитре n8n
- [ ] Учетные данные можно настроить и сохранить
- [ ] Get Prompt возвращает данные для существующего slug
- [ ] Get Prompt с параметрами version_number и status работает
- [ ] Track Event успешно отправляет данные
- [ ] trace_id передается между нодами Get Prompt и Track Event

### При изменении кода

```bash
# 1. Внесите изменения в src/
# 2. Пересоберите
npm run build

# 3. Перезапустите n8n
# Изменения автоматически подтянутся благодаря npm link

# 4. Протестируйте в workflow
```

---

## 2. Как использовать SDK в облачном n8n (https://sterlinglaw.app.n8n.cloud)

### После публикации на npm (см. раздел 3):

#### Шаг 1: Установка в облачном n8n

1. Войдите в ваш n8n Cloud: https://sterlinglaw.app.n8n.cloud
2. Перейдите в **Settings** → **Community Nodes**
3. Нажмите **Install**
4. Введите: `n8n-nodes-xr2`
5. Нажмите **Install**
6. Дождитесь установки (может занять несколько минут)

#### Шаг 2: Настройка API ключа

1. Перейдите в **Settings** → **Credentials** → **New**
2. Найдите "xR2 API"
3. Вставьте ваш Product API ключ из https://xr2.uk
4. Нажмите **Save**

#### Шаг 3: Создание первого workflow

1. Создайте новый workflow
2. Добавьте любой trigger (например, Webhook или Schedule)
3. Добавьте xR2 ноду
4. Настройте операцию (Get Prompt или Track Event)
5. Запустите workflow

### Примеры использования

#### Пример 1: Webhook с динамическим промптом

```
[Webhook Trigger]
  → [xR2: Get Prompt (slug из параметра запроса)]
  → [HTTP: OpenAI API]
  → [xR2: Track Event]
  → [Webhook Response]
```

#### Пример 2: Запланированное обновление контента

```
[Schedule Trigger: Каждый час]
  → [xR2: Get Prompt slug="daily-summary"]
  → [Database: Обновить конфигурацию]
  → [xR2: Track Event "config_updated"]
```

#### Пример 3: A/B тестирование промптов

```
[HTTP Request Trigger]
  → [Function: Случайный выбор A/B]
  → [Switch]
      ├─ Version A → [xR2: Get Prompt slug="prompt-v1"]
      └─ Version B → [xR2: Get Prompt slug="prompt-v2"]
  → [OpenAI]
  → [xR2: Track Event с версией]
```

### Доступ к данным промпта

В других нодах используйте выражения:

```javascript
// Содержимое промпта
{{ $('xR2').item.json.content }}

// ID отслеживания
{{ $('xR2').item.json.trace_id }}

// Конфигурация модели
{{ $('xR2').item.json.model_config.model_name }}
{{ $('xR2').item.json.model_config.temperature }}
{{ $('xR2').item.json.model_config.max_tokens }}

// Переменные
{{ $('xR2').item.json.variables }}

// Номер версии
{{ $('xR2').item.json.version_number }}
```

### Обработка ошибок

Добавьте IF ноду после xR2 для проверки ошибок:

```
[xR2: Get Prompt]
  → [IF: проверка на ошибки]
      ├─ Успех → [Продолжить workflow]
      └─ Ошибка → [Отправить уведомление]
```

---

## 3. Как опубликовать SDK для других пользователей

### Подготовка к публикации

#### Шаг 1: Создание аккаунта на npm

1. Перейдите на https://www.npmjs.com/signup
2. Создайте аккаунт
3. Подтвердите email
4. Включите 2FA (рекомендуется)

#### Шаг 2: Проверка package.json

Убедитесь, что в файле правильно заполнены:

```json
{
  "name": "n8n-nodes-xr2",
  "version": "0.1.0",
  "description": "n8n community nodes for xR2 API",
  "keywords": ["n8n-community-node", "n8n-nodes", "xr2"],
  "license": "MIT",
  "repository": {
    "type": "git",
    "url": "git+https://github.com/channeler-ai/xr2.git"
  }
}
```

#### Шаг 3: Тестовая сборка

```bash
cd /Users/pavelkuzko/Documents/channeler/xR2/sdk/n8n

# Очистить предыдущие сборки
npm run clean

# Установить зависимости
npm install

# Собрать проект
npm run build

# Проверить содержимое dist/
ls -la dist/
```

**Ожидаемые файлы в dist/:**
- `index.js` и `index.d.ts`
- `credentials/XR2Api.credentials.js` и `.d.ts`
- `nodes/XR2/XR2.node.js` и `.d.ts`
- `helpers/http.js` и `.d.ts`

#### Шаг 4: Тестовая упаковка

```bash
# Создать тестовый пакет
npm pack

# Это создаст файл n8n-nodes-xr2-0.1.0.tgz

# Проверить, что будет опубликовано
npm publish --dry-run
```

Внимательно проверьте список файлов - убедитесь, что:
- ✅ Включены все файлы из `dist/`
- ✅ Включен README.md
- ✅ Включен LICENSE
- ❌ НЕ включены исходники (`src/`), если не нужны
- ❌ НЕ включены node_modules
- ❌ НЕ включены тестовые файлы

### Публикация

#### Шаг 1: Вход в npm

```bash
npm login
```

Введите:
- Username
- Password
- Email
- One-time password (если включена 2FA)

#### Шаг 2: Публикация первой версии

```bash
cd /Users/pavelkuzko/Documents/channeler/xR2/sdk/n8n

# Убедитесь, что версия в package.json - 0.1.0 или выше
npm publish
```

**Важно:** Первая публикация публичного пакета по умолчанию публичная. Если хотите приватный пакет, используйте:
```bash
npm publish --access restricted
```

#### Шаг 3: Проверка публикации

1. Откройте: https://www.npmjs.com/package/n8n-nodes-xr2
2. Убедитесь, что:
   - Пакет отображается корректно
   - README отображается
   - Версия правильная
   - Все файлы на месте

#### Шаг 4: Тестирование установки

```bash
# В отдельной директории
mkdir test-install && cd test-install
npm install n8n-nodes-xr2

# Проверить установку
ls node_modules/n8n-nodes-xr2/dist/
```

### После публикации

#### 1. Создание git тега

```bash
cd /Users/pavelkuzko/Documents/channeler/xR2/sdk/n8n

git tag -a v0.1.0 -m "Release v0.1.0 - Initial release"
git push origin v0.1.0
```

#### 2. Создание GitHub Release

1. Перейдите в ваш репозиторий на GitHub
2. Нажмите **Releases** → **Create a new release**
3. Выберите тег `v0.1.0`
4. Заполните описание релиза:

```markdown
## v0.1.0 - Initial Release

### Features
- Get Prompt operation - fetch prompts from xR2 by slug
- Track Event operation - send analytics events
- Support for version filtering
- Support for status filtering
- Full TypeScript support
- Automatic authentication via n8n credentials

### Installation
```bash
npm install n8n-nodes-xr2
```

Or install via n8n GUI: Settings → Community Nodes → Install `n8n-nodes-xr2`

### Documentation
- See README.md for full usage instructions
- See TESTING.md for local development guide
```

5. Нажмите **Publish release**

#### 3. Обновление документации

Обновите следующие файлы/места:
- ✅ README в главном репозитории xR2
- ✅ Документацию на сайте xr2.uk
- ✅ Примеры интеграций

### Обновление пакета

#### Исправление багов (patch версия: 0.1.0 → 0.1.1)

```bash
cd /Users/pavelkuzko/Documents/channeler/xR2/sdk/n8n

# 1. Исправьте баг в коде
# 2. Протестируйте

# 3. Обновите версию
npm version patch

# 4. Опубликуйте
npm publish

# 5. Загрузите тег в git
git push && git push --tags
```

#### Новые функции (minor версия: 0.1.0 → 0.2.0)

```bash
# 1. Реализуйте новую функцию
# 2. Обновите документацию
# 3. Протестируйте

# 4. Обновите версию
npm version minor

# 5. Опубликуйте
npm publish

# 6. Загрузите тег в git
git push && git push --tags

# 7. Создайте GitHub Release с описанием изменений
```

#### Критические изменения (major версия: 0.1.0 → 1.0.0)

```bash
# 1. Реализуйте изменения
# 2. Создайте migration guide в документации
# 3. Протестируйте

# 4. Обновите версию
npm version major

# 5. Опубликуйте
npm publish

# 6. Загрузите тег в git
git push && git push --tags

# 7. Создайте GitHub Release с BREAKING CHANGES
```

### Решение проблем

#### "Package name already exists"

Имя `n8n-nodes-xr2` уже может быть занято. Варианты:
1. Проверьте, не ваш ли это пакет
2. Используйте scoped package: `@ваша-организация/n8n-nodes-xr2`
3. Выберите другое уникальное имя

#### "You must be logged in to publish packages"

```bash
npm logout
npm login
```

#### "You cannot publish over the previously published versions"

Нельзя перезаписать уже опубликованную версию:
```bash
# Увеличьте версию
npm version patch
npm publish
```

#### Build ошибается перед публикацией

```bash
# Проверьте TypeScript ошибки
npm run build

# Если есть ошибки, исправьте их
# Затем повторите попытку
npm publish
```

---

## Быстрая справка по командам

### Разработка

```bash
# Установка зависимостей
npm install

# Сборка
npm run build

# Очистка
npm run clean

# Локальное тестирование
npm link                     # В директории SDK
cd ~/.n8n/custom && npm link n8n-nodes-xr2  # Подключение к n8n
n8n start                    # Запуск n8n
```

### Публикация

```bash
# Логин
npm login

# Проверка перед публикацией
npm publish --dry-run

# Тестовая упаковка
npm pack

# Публикация
npm publish

# Обновление версии
npm version patch   # 0.1.0 -> 0.1.1
npm version minor   # 0.1.0 -> 0.2.0
npm version major   # 0.1.0 -> 1.0.0

# Git теги
git tag -a v0.1.0 -m "Release v0.1.0"
git push origin v0.1.0
```

### Отладка

```bash
# Запуск n8n с подробными логами
n8n start --verbose

# Проверка пакета на npm
npm info n8n-nodes-xr2

# Проверка установленных файлов
ls node_modules/n8n-nodes-xr2/dist/

# Тестирование API напрямую
curl -X POST https://xr2.uk/api/v1/get-prompt \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"slug": "your-slug", "source_name": "n8n_sdk"}'
```

---

## Требования n8n для community nodes

✅ **Обязательно:**
- `package.json` должен содержать `"n8n-community-node"` в `keywords`
- Экспорт нод в формате, который ожидает n8n
- Credentials должны реализовывать `ICredentialType`
- Nodes должны реализовывать `INodeType`

✅ **Рекомендуется:**
- Чистая документация с примерами
- SVG иконка для ноды
- Правильная обработка ошибок
- TypeScript типы

---

## Полезные ссылки

- **n8n Документация**: https://docs.n8n.io
- **n8n Community**: https://community.n8n.io
- **npm Package**: https://www.npmjs.com/package/n8n-nodes-xr2
- **xR2 Dashboard**: https://xr2.uk
- **GitHub Repo**: https://github.com/channeler-ai/xr2
- **Создание n8n nodes**: https://docs.n8n.io/integrations/creating-nodes/

---

## Поддержка

### Проблемы с SDK
Откройте issue на GitHub: https://github.com/channeler-ai/xr2/issues

### Проблемы с n8n
Форум сообщества: https://community.n8n.io

### Проблемы с xR2 API
Свяжитесь с поддержкой xR2 через dashboard

---

## Чеклист перед публикацией

- [ ] Код протестирован локально
- [ ] Все тесты проходят
- [ ] Документация обновлена
- [ ] README.md актуален
- [ ] package.json заполнен корректно
- [ ] Версия обновлена согласно semver
- [ ] npm account готов и залогинен
- [ ] `npm publish --dry-run` проверен
- [ ] .npmignore настроен правильно
- [ ] Нет секретов/ключей в коде
- [ ] LICENSE файл на месте

После публикации:
- [ ] Пакет проверен на npmjs.com
- [ ] Тестовая установка работает
- [ ] Git тег создан
- [ ] GitHub Release создан
- [ ] Документация обновлена

---

**Версия документа**: 1.0
**Последнее обновление**: Ноябрь 2025
